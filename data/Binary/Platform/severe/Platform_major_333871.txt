Race condition causes infinite loop